name: Pull Request Tests

on:
  pull_request:
    branches: [ "master" ]

permissions: read-all

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'      
      - name: Install
        run: yarn --frozen-lockfile 
      - name: Unit Test
        run: npx lerna run test
        env:
          DD_KEY: ${{ secrets.DD_KEY }}
          CF_SPACE: ${{ secrets.CF_SPACE }}
          CF_KEY: ${{ secrets.CF_KEY }}     
      - name: Web Build
        run: yarn cloudflare-build
        env:
          API_KEY: ${{ secrets.API_KEY }}
          CONTENTFUL_SPACE_ID: ${{ secrets.CF_SPACE }}
          CONTENTFUL_ACCESS_TOKEN: ${{ secrets.CF_KEY }}
          API_PORT: "443"
          API_PROTOCOL: "https" 
          API_DOMAIN: "api.tranmere-web.com"
      - name: Web Deploy
        id: deploy
        uses: cloudflare/wrangler-action@05f17c4a695b4d94b57b59997562c6a4624c64e4
        with:
          apiToken: ${{ secrets.CLOUDFLARE_AUTH_KEY }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./packages/site
          command: pages deploy .vercel/output/static --project-name=tranmere-web                
      
      - name: Check HTTP status
        uses: gerdemann/http-status-code@944938ed534b092b9f7e1e5c6b08c5d9bbc35162
        with:
          url: ${{ steps.deploy.outputs.deployment-url }}
          code: 200
          timeout: 60
          interval: 10

      - name: Run Binoculars
        uses: foo-software/binoculars-action@21e84de9937428b73a157aef7226113dc3ce1fd3
        with:
          accessToken: ${{ secrets.GITHUB_TOKEN }}
          author: ${{ github.actor }}
          branch: ${{ github.ref }}
          enableComments: true
          minScore: 80
          urls: ${{ steps.deploy.outputs.deployment-url }}
          sha: ${{ github.sha }}        
